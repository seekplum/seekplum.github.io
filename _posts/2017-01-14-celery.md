---
layout: post
title:  celery异步任务队列
categories: python
tags: celery
thread: celery
---

**Celery 是一个异步任务队列。你可以使用它在你的应用上下文之外执行任务。总的想法就是你的应用程序可能需要执行任何消耗资源的任务都可以交给任务队列，让你的应用程序自由和快速地响应客户端请求。**

**使用 Celery 运行后台任务并不像在线程中这样做那么简单。但是好处多多，Celery 具有分布式架构，使你的应用易于扩展。一个 Celery 安装有三个核心组件**：

> Celery 客户端: 用于发布后台作业。
> Celery workers: 这些是运行后台作业的进程。Celery 支持本地和远程的 workers
> 消息代理: 客户端通过消息队列和 workers 进行通信，Celery 支持多种方式来实现这些队列。最常用的代理就是 RabbitMQ 和 Redis

* tasks.py
```
# !/usr/bin/env python
# -*- coding: utf-8 -*-
"""
在当前目录下执行 celery -A tasks worker -B --loglevel=info
"""
from celery import Celery
import time

app = Celery('tasks')
app.config_from_object('config')

@app.task
def add(x, y):
    result = x + y
    now_time = time.strftime('%Y-%m-%d %H:%M:%S', time.localtime(time.time()))
    print "\n hjd now time： %s, %s + %s = %s\n" % (now_time, x, y, result)
    return result
```
* config.py
```
# redis作为代理服务器
CELERY_RESULT_BACKEND = 'redis://127.0.0.1:6379/1'
BROKER_URL = 'redis://127.0.0.1:6379/0'
```
* 执行方式，在tasks.py同目录下执行下面语句
```
celery -A tasks worker --loglevel=info
在tasks.py同目录下打开python命令行
>>> from tasks import add
>>> res = add.delay(4, 3)
# delay() 和 apply_async() 的返回值是一个表示任务的对象，这个对象可以用于获取任务状态。我将会在本文的后面展示如何获取任务状态等信息
```
