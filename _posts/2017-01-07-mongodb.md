---
layout: post
title: mongodb数据库操作
categories: python
tags: mongodb
thread: mongodb
---

## 安装Mongodb
1.导入包管理系统使用的公钥

> sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 0C49F3730359A14518585931BC711F9BA15703C6

2.为MongoDB创建一个列表文件

根据版本创建/etc/apt/sources.list.d/mongodb-org-3.4.list 列表文件

* Ubuntu 14.04

```
echo "deb [ arch=amd64 ] http://repo.mongodb.org/apt/ubuntu trusty/mongodb-org/3.4 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-3.4.list
```

* Ubuntu 16.04

```
echo "deb [ arch=amd64,arm64 ] http://repo.mongodb.org/apt/ubuntu xenial/mongodb-org/3.4 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-3.4.list
```

3.更新本地包数据库

> sudo apt-get update

4.安装最新版本的MongoDB

> sudo apt-get install -y mongodb-org

> MongoDB在默认情况下是没有认证权限的，要想使设置的用户名和密码有效，第一步先修改ＭongoDB的配置文件，　将/etc/mongod.conf文件中的auth=true前面的注释去掉


## 切换到admin
> use admin

## 增加用户名和密码
> db.addUser("root","root")

## 再切换到集合xxxx
> use xxxx

## 增加用户名和密码
> db.addUser("root","root")

## 查看Mongodb服务状态
> sudo service mongodb status

## 停止服务
> sudo service mongodb stop

## 启动服务
> sudo service mongodb start

# 查看
> show collections
> db.system.users.find()

## 验证用户名密码是否正确
> db.auth('root','root')


## mongodb备份整个数据库
* 无密码

> mongodump -h 127.0.0.1:27017 -d test -o /home/lcx/Desktop/mongodb/

* 有密码

> mongodump -h 127.0.0.1 --port 27017 -u abc -p abc -d test --authenticationDatabase admin -o /home/lcx/Desktop/mongodb/

## mongodb还原整个数据库
* 无密码

> mongorestore -h 127.0.0.1:27017 -d test --directoryperdb /home/lcx/Desktop/mongodb/test

* 有密码

> mongorestore -h 127.0.0.1 --port 27017 -u abc -p abc -d test --authenticationDatabase admin --directoryperdb /home/lcx/Desktop/mongodb/test

## 查询数据库/表信息
> db.stats(); # 查看数据库信息
> db.posts.stats();  # 查看数据库表信息

## Python语法

### 连接mongodb
```
import pymongo
connection = pymongo.Connection("127.0.0.1", 27017)
# 数据库为ebdb_sm
db = connection.ebdb_sm
# 账号为:sm 密码为:sm.com
db.authenticate("sm", "sm.com")
```

### 插入数据
```python
import pymongo
connection=pymongo.Connection('192.168.0.62', 27017)
# connection = MongoClient()  # 链接默认的host和port
db = connection.ebdb_smartsys
ebc_wechat_oa = {
    "appid": "xx",
    "secret": "xx",
    "wxtoken": "xx",
    "encoding_aes_key": "xx",
    "pid": "xx",
    "factory_uid": "xx",
    "create_date": "xx",
}
posts = db.ebc_wechat_oa
posts.insert(ebc_wechat_oa)
```

### 查询数据
```python

import pymongo

connection = pymongo.Connection("192.168.0.62", 27017)
db = connection.ebdb_smartsys
db.authenticate("smartsys", "smartsys.com") #账号为:smartsys密码为:smartsys.com
result = db.ebc_wechat_oa.find_one({'factory_uid': "xx"})
```

### 大于，小于
```
date_range = {'$gte': min_date, '$lte': max_date}
params['upload_date'] = date_range
```

### 如果存在name为user1，则更新age为21，如果不存在，则插入这条数据
```
db.users.update({'name':'user5'}, {'$set': {'age': 22}, '$setOnInsert': {'index':5}}, upsert=True)
db.users.update({'name':'user5'}, {'$set': {'age': 22}, upsert=True)
```

### 版本区别
> 对应pymongo2.x和3.x有所区别需要注意
> connection=pymongo.Connection('localhost',27017)
> AttributeError:'module' object has no attribute 'Connection'
> 原因：pymongo版本不对，pip install pymongo安装的是3.2的版本

### 查询不匹配的元素
```
params["id"] = {"$nin": uid_name}	# uid_name是一个列表
```

## mongodb语法

### 大于，小于
```
db.getCollection('ebc_wechat_oa').find({'appid':{$gte:'3',$lte:'7'}})
db.getCollection('ebc_ad_content').find({'upload_date':{$gte: new Date('2016/03/26'),$lte: new Date('2016/04/03')}})

```

### 只想删掉一条记录，可以设置 justOne 为 1或true
```
db.person.remove({name : "peter"},true)
```

### 如果存在name为user1，则更新age为21，如果不存在，则插入这条数据
```
db.user.update({"name":"user1"}, {"$set":{"age":21}}, {"upsert":"true"})
db.user.update({"name":"user1"}, {"$set":{"age":21}, "$setOnInsert":{"sex":"female"}}, {"upsert":"true"})
```

### 查询不匹配的元素
```
db.users.find({"pageViews":{"$nin":[10000,20000]}})　＃mongodb中
```